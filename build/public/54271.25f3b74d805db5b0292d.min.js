(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[54271,48894,62735,54625,86193],{30524:(w,k,m)=>{"use strict";var C,y;C=[m(7237),m(42441),m(81018),m(98900),m(20363),m(46862),m(75208),m(57930),m(7148),m(2585),m(85233),m(63281),m(7927),m(93216),m(74344),m(33371)],y=function(E,g,r,p,h,a,o,s,l,c,d,u,v,x,A,T){const n={initialised:!1,activeAutocomplete:{}};let R=!1,D=null;return $(window).on("action:ajaxify.start",function(){n.destroyAutoComplete(ajaxify.data.roomId),ajaxify.data.template.chats&&(ajaxify.data.roomId&&socket.emit("modules.chats.leave",ajaxify.data.roomId),ajaxify.data.publicRooms&&socket.emit("modules.chats.leavePublic",ajaxify.data.publicRooms.map(t=>t.roomId)))}),n.init=function(){utils.isMobile()||$('.chats-full [data-bs-toggle="tooltip"]').tooltip({trigger:"hover",container:"#content"}),socket.emit("modules.chats.enterPublic",ajaxify.data.publicRooms.map(i=>i.roomId));const t=utils.findBootstrapEnvironment();D=$('[component="chat/nav-wrapper"]'),n.initialised||(n.addSocketListeners(),n.addGlobalEventListeners()),r.init(),n.addEventListeners(),n.setActive(ajaxify.data.roomId),(t==="md"||t==="lg"||t==="xl"||t==="xxl")&&n.addHotkeys(),n.initialised=!0;const e=$('[component="chat/message/content"]');a.wrapImagesInLinks(e),a.scrollToBottomAfterImageLoad(e),p.init(),d.fire("action:chat.loaded",$(".chats-full"))},n.addEventListeners=function(){const{roomId:t}=ajaxify.data,e=$('[component="chat/main-wrapper"]'),i=$('[component="chat/message/content"]'),f=E.get("chat/controls");n.addSendHandlers(t,$(".chat-input"),$('.expanded-chat button[data-action="send"]')),n.addPopoutHandler(),n.addActionHandlers(E.get("chat/message/window"),t),n.addManageHandler(t,f.find('[data-action="manage"]')),n.addRenameHandler(t,f.find('[data-action="rename"]')),n.addLeaveHandler(t,f.find('[data-action="leave"]')),n.addDeleteHandler(t,f.find('[data-action="delete"]')),n.addScrollHandler(t,ajaxify.data.uid,i),n.addScrollBottomHandler(i),n.addParentHandler(e),n.addCharactersLeftHandler(e),n.addTextareaResizeHandler(e),n.addTypingHandler(e,t),n.addIPHandler(e),n.createAutoComplete(t,$('[component="chat/input"]')),n.addUploadHandler({dragDropAreaEl:$(".chats-full"),pasteEl:$('[component="chat/input"]'),uploadFormEl:$('[component="chat/upload"]'),uploadBtnEl:$('[component="chat/upload/button"]'),inputEl:$('[component="chat/input"]')}),$('[data-action="close"]').on("click",function(){n.switchChat()}),o.init(t,e),n.addNotificationSettingHandler(t,e),s.init(t,e),n.addPublicRoomSortHandler(),n.addTooltipHandler(e),l.init(e)},n.addPublicRoomSortHandler=function(){app.user.isAdmin&&!utils.isMobile()&&app.loadJQueryUI(()=>{const t=$('[component="chat/public"]');t.sortable({handle:'[component="chat/public/room/sort/handle"]',items:'[component="chat/public/room"]',axis:"y",update:async function(){const e={roomIds:[],scores:[]};t.find("[data-roomid]").each((i,f)=>{e.roomIds.push($(f).attr("data-roomid")),e.scores.push(i)}),await socket.emit("modules.chats.sortPublicRooms",e)}})})},n.addTooltipHandler=function(t){utils.isMobile()||(t.find("[data-manual-tooltip]").tooltip({trigger:"manual",animation:!1,placement:"bottom"}).on("mouseenter",function(e){const i=$(e.target);i.hasClass("dropdown-menu")||!!i.parents(".dropdown-menu").length||$(this).tooltip("show")}).on("click mouseleave",function(){$(this).tooltip("hide")}),t.tooltip({selector:'[component="chat/message/controls"] button',placement:"top",container:"#content",animation:!1,trigger:"hover"}))},n.addNotificationSettingHandler=function(t,e){const i=e.find('[component="chat/notification/setting"]');i.find("[data-value]").on("click",async function(){i.find("i.fa-check").addClass("hidden");const f=$(this);f.find("i.fa-check").removeClass("hidden"),i.find('[component="chat/notification/setting/icon"]').attr("class",`fa ${f.attr("data-icon")}`),await socket.emit("modules.chats.setNotificationSetting",{roomId:t,value:f.attr("data-value")})})},n.addParentHandler=function(t){t.off("click",'[component="chat/message/parent"]').on("click",'[component="chat/message/parent"]',function(){const e=$(this);e.find('[component="chat/message/parent/content"]').toggleClass("line-clamp-1"),e.find(".chat-timestamp").toggleClass("hidden"),e.toggleClass("flex-column").toggleClass("flex-row");const i=e.parents('[component="chat/message/content"]');i.length&&a.isAtBottom(i)&&a.scrollToBottom(i)})},n.addUploadHandler=function(t){T.init({dragDropAreaEl:t.dragDropAreaEl,pasteEl:t.pasteEl,uploadFormEl:t.uploadFormEl,uploadBtnEl:t.uploadBtnEl,route:"/api/post/upload",callback:function(e){const i=t.inputEl;let f=i.val();e.forEach(b=>{f=f+(f.endsWith(`
`)?"":`
`)+(b.isImage?"!":"")+`[${b.filename}](${b.url})
`}),i.val(f).trigger("input")}})},n.addIPHandler=function(t){t.off("click",".chat-ip-button").on("click",".chat-ip-button",async function(){const e=$(this);let i=e.attr("data-ip");if(i){navigator.clipboard.writeText(i),e.translateText("[[global:copied]]"),setTimeout(()=>e.text(i),2e3);return}const f=e.parents("[data-mid]").attr("data-mid");i=await socket.emit("modules.chats.getIP",f),e.text(i).attr("data-ip",i)})},n.addPopoutHandler=function(){$('[data-action="pop-out"]').on("click",function(){const t=E.get("chat/input").val(),e=ajaxify.data.roomId;app.previousUrl&&app.previousUrl.match(/chats/)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats",function(){x.openChat(e,ajaxify.data.uid)},!0):(window.history.go(-1),x.openChat(e,ajaxify.data.uid)),$(window).one("action:chat.loaded",function(){E.get("chat/input").val(t)})})},n.addScrollHandler=function(t,e,i){let f=!1;i.off("scroll").on("scroll",utils.debounce(function(){if(a.toggleScrollUpAlert(i),f)return;const b=(i[0].scrollHeight-i.height())*.1;if(i.scrollTop()>=b)return;f=!0;const I=parseInt(i.children("[data-mid]").length,10);A.get(`/chats/${t}/messages`,{uid:e,start:I}).then(S=>{if(S=S.messages,!S){f=!1;return}if(S=S.filter(function(j){return!$('[component="chat/message"][data-mid="'+j.messageId+'"]').length}),!S.length){f=!1;return}a.parseMessage(S,function(j){const H=i.scrollTop(),L=i[0].scrollHeight;i.prepend(j),a.onMessagesAddedToDom(j),i.scrollTop(i[0].scrollHeight-L+H),f=!1})}).catch(v.error)},100))},n.addScrollBottomHandler=function(t){t.parents('[component="chat/message/window"]').find('[component="chat/messages/scroll-up-alert"]').off("click").on("click",function(){a.scrollToBottom(t)})},n.addCharactersLeftHandler=function(t){t.find('[component="chat/input"]').on("change keyup paste",function(){a.updateRemainingLength(t)})},n.addTextareaResizeHandler=function(t){const e=t.find('[component="chat/input"]');e.on("input",function(){const i=t.find('[component="chat/message/content"]'),f=a.isAtBottom(i);e.css({height:0}),e.css({height:a.calcAutoTextAreaHeight(e)+"px"}),f&&a.scrollToBottom(i)})},n.addTypingHandler=function(t,e){const i=t.find('[component="chat/input"]');function f(S){socket.emit("modules.chats.typing",{roomId:e,typing:S,username:app.user.username})}i.on("focus",()=>i.val()&&f(!0)),i.on("blur",()=>f(!1));let b=0,I=!!i.val();i.on("input",function(){const S=!!i.val();S!==I?(clearTimeout(b),b=0,I=S,f(I)):b||(b=setTimeout(()=>{f(!!i.val()),b=0},5e3))})},n.addActionHandlers=function(t,e){t.on("click","[data-mid] [data-action]",function(){const i=$(this).parents("[data-mid]"),f=i.attr("data-mid"),b=this.getAttribute("data-action");switch($(this).tooltip("dispose"),b){case"reply":a.prepReplyTo(i,t);break;case"edit":a.prepEdit(i,f,e);break;case"delete":a.delete(f,e);break;case"restore":a.restore(f,e);break;case"pin":l.pin(f,e);break;case"unpin":l.unpin(f,e);break}})},n.addHotkeys=function(){g.bind("ctrl+up",function(){const e=$(".chats-list .active").prevAll("[data-roomid]").first();e.length&&e.attr("data-roomid")&&n.switchChat(e.attr("data-roomid"))}),g.bind("ctrl+down",function(){const e=$(".chats-list .active").nextAll("[data-roomid]").first();e.length&&e.attr("data-roomid")&&n.switchChat(e.attr("data-roomid"))}),g.bind("up",function(t){const e=E.get("chat/input");if(t.target===e.get(0)&&!e.val()){const i=E.get("chat/messages").find('.chat-message[data-self="1"]').last();if(!i.length)return;const f=i.attr("data-mid");a.prepEdit(i,f,ajaxify.data.roomId)}})},n.addManageHandler=function(t,e){h.init(t,e)},n.addLeaveHandler=function(t,e){e.on("click",function(){u.confirm({size:"small",title:"[[modules:chat.leave]]",message:'<p>[[modules:chat.leave-prompt]]</p><p class="form-text">[[modules:chat.leave-help]]</p>',callback:function(i){i&&A.del(`/chats/${t}/users/${app.user.uid}`,{}).then(()=>{const f=e.parents(".chat-modal");f.length?x.close(f):(n.destroyAutoComplete(t),ajaxify.go("chats"))}).catch(v.error)}})})},n.addDeleteHandler=function(t,e){e.on("click",function(){u.confirm({size:"small",title:"[[modules:chat.delete]]",message:"<p>[[modules:chat.delete-prompt]]</p>",callback:function(i){i&&A.del(`/admin/chats/${t}`,{}).then(()=>{const f=e.parents(".chat-modal");f.length?x.close(f):(n.destroyAutoComplete(t),ajaxify.go("chats"))}).catch(v.error)}})})},n.addRenameHandler=function(t,e){e.on("click",async function(){const{roomName:i}=await A.get(`/chats/${t}`),f=await app.parseAndTranslate("modals/rename-room",{name:i}),b=u.dialog({title:"[[modules:chat.rename-room]]",message:f,onEscape:!0,buttons:{save:{label:"[[global:save]]",className:"btn-primary",callback:function(){return A.put(`/chats/${t}`,{name:b.find("#roomName").val()}).then(()=>{b.modal("hide")}).catch(v.error),!1}}}})})},n.addSendHandlers=function(t,e,i){utils.isMobile()||e.off("keypress").on("keypress",function(f){if(f.which===13&&!f.shiftKey)return a.sendMessage(t,e),!1}),i.off("click").on("click",function(){return a.sendMessage(t,e),e.focus(),!1})},n.createAutoComplete=function(t,e,i={}){if(!e.length)return;const f={element:e,strategies:[],options:{style:{"z-index":2e4,flex:0,top:"inherit"},placement:"top",className:`chat-autocomplete-dropdown-${t} dropdown-menu textcomplete-dropdown`,...i}};if($(window).trigger("chat:autocomplete:init",f),f.strategies.length){const b=c.setup(f);return t&&(n.activeAutocomplete[t]=b),b}},n.destroyAutoComplete=function(t){n.activeAutocomplete[t]&&(n.activeAutocomplete[t].destroy(),delete n.activeAutocomplete[t])},n.leave=function(t){const e=t.attr("data-roomid");A.del(`/chats/${e}/users/${app.user.uid}`,{}).then(()=>{parseInt(e,10)===parseInt(ajaxify.data.roomId,10)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats"):t.remove(),n.destroyAutoComplete(e);const i=x.getModal(e);i.length&&x.close(i)}).catch(v.error)},n.switchChat=function(t){t||(t=""),n.destroyAutoComplete(ajaxify.data.roomId),socket.emit("modules.chats.leave",ajaxify.data.roomId);const e="user/"+ajaxify.data.userslug+"/chats/"+t+window.location.search;if(!self.fetch)return ajaxify.go(e);const i=new URL(document.location).searchParams;i.set("switch",1);const f=`${config.relative_path}/api/user/${ajaxify.data.userslug}/chats/${t}?${i.toString()}`;fetch(f,{credentials:"include"}).then(async function(b){if(!b.ok)return console.warn("[search] Received "+b.status);const I=await b.json(),S=await app.parseAndTranslate("partials/chats/message-window",I),j=E.get("chat/main-wrapper");j.html(S),j.attr("data-roomid",t),D=$('[component="chat/nav-wrapper"]'),S.find(".timeago").timeago(),ajaxify.data={...ajaxify.data,...I,roomId:t},ajaxify.updateTitle(ajaxify.data.title),$("body").toggleClass("chat-loaded",!!t),j.find('[data-bs-toggle="tooltip"]').tooltip({trigger:"hover",container:"#content"}),n.setActive(t),n.addEventListeners(),d.fire("action:chat.loaded",$(".chats-full")),a.scrollToBottomAfterImageLoad(j.find('[component="chat/message/content"]')),history.pushState&&history.pushState({url:e},null,window.location.protocol+"//"+window.location.host+config.relative_path+"/"+e)}).catch(function(b){console.warn("[search] "+b.message)})},n.addGlobalEventListeners=function(){$(window).on("mousemove keypress click",function(){R&&ajaxify.data.roomId&&(A.del(`/chats/${ajaxify.data.roomId}/state`,{}),R=!1)})},n.addSocketListeners=function(){socket.on("event:chats.receive",function(t){x.isFromBlockedUser(t.fromUid)||parseInt(t.roomId,10)===parseInt(ajaxify.data.roomId,10)&&(t.self=parseInt(app.user.uid,10)===parseInt(t.fromUid,10)?1:0,R||(R=t.self===0),t.message.self=t.self,t.message.timestamp=Math.min(Date.now(),t.message.timestamp),t.message.timestampISO=utils.toISOString(t.message.timestamp),a.appendChatMessage($('[component="chat/message/content"]'),t.message))}),socket.on("event:chats.public.unread",function(t){x.isFromBlockedUser(t.fromUid)||x.isLookingAtRoom(t.roomId)||app.user.uid===parseInt(t.fromUid,10)||(n.markChatPageElUnread(t),n.increasePublicRoomUnreadCount(D.find("[data-roomid="+t.roomId+"]")))}),socket.on("event:user_status_change",function(t){app.updateUserStatus($('.chats-list [data-uid="'+t.uid+'"] [component="user/status"]'),t.status)}),a.addSocketListeners(),socket.on("event:chats.roomRename",function(t){const e=E.get("chat/recent/room",t.roomId);if(e.length){const f=e.find('[component="chat/room/title"]');ajaxify.data.roomName=t.newName,f.translateText(t.newName?t.newName:ajaxify.data.usernames)}const i=$(`[component="chat/main-wrapper"][data-roomid="${t.roomId}"] [component="chat/header/title"]`);i.length&&i.html(t.newName?`<i class="fa ${ajaxify.data.icon} text-muted"></i> ${t.newName}`:ajaxify.data.chatWithMessage)}),socket.on("event:chats.mark",({roomId:t,state:e})=>{$(`[component="chat/recent"] [data-roomid="${t}"], [component="chat/list"] [data-roomid="${t}"], [component="chat/public"] [data-roomid="${t}"]`).each((f,b)=>{const I=$(b);x.markChatElUnread(I,e===1),e===0&&n.updatePublicRoomUnreadCount(I,0)})}),socket.on("event:chats.typing",async t=>{x.isFromBlockedUser(t.uid)||x.updateTypingUserList($(`[component="chat/main-wrapper"][data-roomid="${t.roomId}"]`),t)})},n.markChatPageElUnread=function(t){if(!ajaxify.data.template.chats)return;const e=D.find("[data-roomid="+t.roomId+"]");x.markChatElUnread(e,!0)},n.increasePublicRoomUnreadCount=function(t){const e=t.find('[component="chat/public/room/unread/count"]'),i=(parseInt(e.attr("data-count"),10)||0)+1;n.updatePublicRoomUnreadCount(t,i)},n.updatePublicRoomUnreadCount=function(t,e){const i=t.find('[component="chat/public/room/unread/count"]'),f=e>50?"50+":e;i.toggleClass("hidden",e<=0).text(f).attr("data-count",e)},n.setActive=function(t){if(D.find("[data-roomid]").removeClass("active"),t){socket.emit("modules.chats.enter",t);const e=D.find(`[data-roomid="${t}"]`);e.addClass("active"),e.hasClass("unread")&&(A.del(`/chats/${t}/state`,{}),e.removeClass("unread")),utils.isMobile()||$('.expanded-chat [component="chat/input"]').focus(),a.updateTextAreaHeight($(`[component="chat/messages"][data-roomid="${t}"]`))}D.attr("data-loaded",t?"1":"0")},n}.apply(k,C),y!==void 0&&(w.exports=y)},98900:(w,k,m)=>{"use strict";var C,y;C=[m(7237),m(74344),m(7927),m(85925)],y=function(E,g,r,p){const h={};h.init=function(){E.get("chat/create").on("click",a)};async function a(){let o=[];app.user.isAdmin&&(o=await socket.emit("groups.getChatGroups",{}));const s=await app.parseAndTranslate("modals/create-room",{user:app.user,groups:o}),l=bootbox.dialog({title:"[[modules:chat.create-room]]",message:s,onEscape:!0,buttons:{save:{label:"[[global:create]]",className:"btn-primary",callback:function(){const d=l.find('[component="chat/room/name"]').val(),u=l.find('[component="chat/room/users"] [component="chat/user"]').find("[data-uid]").map((A,T)=>$(T).attr("data-uid")).get(),v=l.find('[component="chat/room/type"]').val(),x=l.find('[component="chat/room/groups"]').val();return v==="private"&&!u.length?(r.error("[[error:no-users-selected]]"),!1):v==="public"&&!x.length?(r.error("[[error:no-groups-selected]]"),!1):app.user.uid?(g.post("/chats",{roomName:d,uids:u,type:v,groups:x}).then(({roomId:A})=>{ajaxify.go("chats/"+A),l.modal("hide")}).catch(r.error),!1):(r.error("[[error:not-logged-in]]"),!1)}}}}),c=l.find('[component="chat/room/users"]');p.init({onSelect:async function(d){const u=await app.parseAndTranslate("modals/create-room","selectedUsers",{selectedUsers:[d]});c.append(u)}}),c.on("click",'[component="chat/room/users/remove"]',function(){$(this).parents("[data-uid]").remove()}),l.find('[component="chat/room/type"]').on("change",function(){const d=$(this).val();l.find('[component="chat/room/public/options"]').toggleClass("hidden",d==="private")})}return h}.apply(k,C),y!==void 0&&(w.exports=y)},20363:(w,k,m)=>{"use strict";var C,y;C=[m(74344),m(7927),m(32230),m(86193),m(75208)],y=function(E,g,r,p,h){const a={};a.init=function(c,d){let u;d.on("click",async function(){let v=[];app.user.isAdmin&&(v=await socket.emit("groups.getChatGroups",{}),Array.isArray(ajaxify.data.groups)&&v.forEach(D=>{D.selected=ajaxify.data.groups.includes(D.name)}));const x=await app.parseAndTranslate("modals/manage-room",{groups:v,user:app.user,room:ajaxify.data});u=bootbox.dialog({title:"[[modules:chat.manage-room]]",message:x,onEscape:!0}),u.attr("component","chat/manage-modal"),l(c,u),o(c,u),s(c,u);const A=u.find('[component="chat/manage/user/list"]'),T=u.find('[component="chat/manage/user/list/search"]');h.addSearchHandler(c,T,async D=>{T.val()?A.html(await app.parseAndTranslate("partials/chats/manage-room-users",D)):l(c,u)}),h.addInfiniteScrollHandler(c,A,async(D,t)=>{D.append(await app.parseAndTranslate("partials/chats/manage-room-users",t))});const n=u.find('[component="chat/manage/user/add/search"]'),R=u.find(".text-danger");p.user(n,function(D,t){R.text(""),E.post(`/chats/${c}/users`,{uids:[t.item.user.uid]}).then(e=>{l(c,u,e),n.val("")}).catch(e=>{r.translate(e.message,function(i){R.text(i)})})}),u.find('[component="chat/manage/save"]').on("click",()=>{const D=u.find('[component="chat/room/notification/setting"]');E.put(`/chats/${c}`,{groups:u.find('[component="chat/room/groups"]').val(),notificationSetting:D.val()}).then(t=>{ajaxify.data.groups=t.groups,ajaxify.data.notificationSetting=t.notificationSetting;const e=t.notificationOptions[0];$('[component="chat/notification/setting"] [data-icon]').first().attr("data-icon",e.icon),$('[component="chat/notification/setting/sub-label"]').translateText(e.subLabel),e.selected&&$('[component="chat/notification/setting/icon"]').attr("class",`fa ${e.icon}`),u.modal("hide")}).catch(g.error)})})};function o(c,d){d.on("click",'[data-action="kick"]',function(){const u=parseInt(this.getAttribute("data-uid"),10);E.del(`/chats/${c}/users/${u}`,{}).then(v=>{l(c,d,v)}).catch(g.error)})}function s(c,d){d.on("click",'[data-action="toggleOwner"]',async function(){const u=parseInt(this.getAttribute("data-uid"),10),v=$(this);await socket.emit("modules.chats.toggleOwner",{roomId:c,uid:u}),v.parents("[data-uid]").find('[component="chat/manage/user/owner/icon"]').toggleClass("hidden")})}async function l(c,d,u){const v=d.find('[component="chat/manage/user/list"]');if(!u)try{u=await E.get(`/chats/${c}/users`,{})}catch{v.find("li").text(await r.translate("[[error:invalid-data]]"))}v.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),v.html(await app.parseAndTranslate("partials/chats/manage-room-users",u)),v.find('[data-bs-toggle="tooltip"]').tooltip()}return a}.apply(k,C),y!==void 0&&(w.exports=y)},57930:(w,k,m)=>{"use strict";var C,y;C=[m(7237),m(7927),m(46862)],y=function(E,g,r){const p={};let h=0,a,o,s,l,c,d;p.init=function(T,n){h=T,o=n.find('[component="chat/message/search/results"]'),s=n.find('[component="chat/message/content"]'),l=n.find('[component="chat/room/search/clear"]'),d=n.find('[component="chat/room/search/container"]'),c=n.find('[component="chat/room/search/toggle"'),a=n.find('[component="chat/room/search"]'),a.on("keyup",utils.debounce(v,250)).on("focus",()=>{a.val()&&v()}),n.find('[component="chat/input"]').on("focus",()=>{o.addClass("hidden"),s.removeClass("hidden")}),l.on("click",u),c.on("click",()=>{d.removeClass("hidden"),c.addClass("hidden"),a.trigger("focus")}),a.on("blur",()=>{a.val()||u()})};function u(){a.val(""),x(),o.addClass("hidden"),l.addClass("hidden"),d.addClass("hidden"),s.removeClass("hidden"),c.removeClass("hidden")}async function v(){const T=a.val();!T||T.length<=2||(l.removeClass("hidden"),socket.emit("modules.chats.searchMessages",{content:T,roomId:h}).then(A).catch(g.error))}function x(){o.children("[data-mid]").remove()}async function A(T){if(x(),!T.length)return o.removeClass("hidden"),s.addClass("hidden"),o.find('[component="chat/message/search/no-results"]').removeClass("hidden");o.find('[component="chat/message/search/no-results"]').addClass("hidden");const n=await app.parseAndTranslate("partials/chats/messages",{messages:T,isAdminOrGlobalMod:app.user.isAdmin||app.user.isGlobalMod});o.append(n),r.onMessagesAddedToDom(o.find('[component="chat/message"]')),s.addClass("hidden"),o.removeClass("hidden")}return p}.apply(k,C),y!==void 0&&(w.exports=y)},7148:(w,k,m)=>{"use strict";var C,y;C=[m(74344),m(7927)],y=function(E,g){const r={};let p;r.init=function(s){p=s,$('[component="chat/pinned/messages/btn"]').on("click",async()=>{const l=p.find('[component="chat/messages/pinned/container"]');if(!l.hasClass("hidden"))return l.addClass("hidden");p.find('[component="chat/user/list"]').addClass("hidden"),await r.refreshList(),l.removeClass("hidden")}),h(p)};function h(s){const l=s.find('[component="chat/messages/pinned"]');l.on("scroll",utils.debounce(async()=>{const c=(l[0].scrollHeight-l.height())*.85;if(l.scrollTop()>c){const d=l.find("[data-index]").last().attr("data-index"),u=await o(parseInt(d,10)+1);if(u&&u.length){const v=await a(u);s.find('[component="chat/messages/pinned"]').append(v)}}},200))}r.refreshList=async function(){const s=await o(0);if(!s.length){p.find('[component="chat/messages/pinned/empty"]').removeClass("hidden"),p.find('[component="chat/messages/pinned"]').html("");return}p.find('[component="chat/messages/pinned/empty"]').addClass("hidden");const l=await a(s);p.find('[component="chat/messages/pinned"]').html(l),l.find(".timeago").timeago()};async function a(s){return await app.parseAndTranslate("partials/chats/pinned-messages-list","messages",{isOwner:ajaxify.data.isOwner,isAdminOrGlobalMod:ajaxify.data.isAdminOrGlobalMod,messages:s})}async function o(s){return await socket.emit("modules.chats.loadPinnedMessages",{roomId:ajaxify.data.roomId,start:s})}return r.pin=function(s,l){E.put(`/chats/${l}/messages/${s}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${s}"]`).toggleClass("pinned",!0),r.refreshList()}).catch(g.error)},r.unpin=function(s,l){E.del(`/chats/${l}/messages/${s}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${s}"]`).toggleClass("pinned",!1),p.find(`[component="chat/messages/pinned"] [data-mid="${s}"]`).remove(),p.find('[component="chat/messages/pinned"] [data-mid]').length||p.find('[component="chat/messages/pinned/empty"]').removeClass("hidden")}).catch(g.error)},r}.apply(k,C),y!==void 0&&(w.exports=y)},75208:(w,k,m)=>{"use strict";var C,y;C=[m(74344)],y=function(E){const g={};let r=0;g.init=function(o,s){const l=s.find('[component="chat/user/list"]');if(!l.length)return;const c=s.find('[component="chat/messages/pinned/container"]');s.find('[component="chat/user/list/btn"]').on("click",()=>{l.toggleClass("hidden"),l.hasClass("hidden")?h():(c.addClass("hidden"),p(o,l))}),$(window).off("action:ajaxify.start",h).one("action:ajaxify.start",h),g.addInfiniteScrollHandler(o,l,async(d,u)=>{d.append(await app.parseAndTranslate("partials/chats/user-list","users",u))})};function p(o,s){r&&clearInterval(r),r=setInterval(()=>{a(o,s)},5e3)}function h(){r&&(clearInterval(r),r=0)}async function a(o,s){if(ajaxify.data.template.chats&&app.isFocused&&s.scrollTop()===0&&!s.hasClass("hidden")){const l=await E.get(`/chats/${o}/users`,{start:0});s.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),s.html(await app.parseAndTranslate("partials/chats/user-list","users",l)),s.find('[data-bs-toggle="tooltip"]').tooltip()}}return g.addInfiniteScrollHandler=function(o,s,l){s.on("scroll",utils.debounce(async()=>{const c=(s[0].scrollHeight-s.height())*.85;if(s.scrollTop()>c){const d=s.find("[data-index]").last().attr("data-index"),u=await E.get(`/chats/${o}/users`,{start:parseInt(d,10)+1});u&&u.users.length&&l(s,u)}},200))},g.addSearchHandler=function(o,s,l){s.on("keyup",utils.debounce(async()=>{const c=s.val(),d=await socket.emit("modules.chats.searchMembers",{username:c,roomId:o});l(d)},200))},g}.apply(k,C),y!==void 0&&(w.exports=y)},85925:(w,k,m)=>{"use strict";var C,y;C=[m(7237),m(74344),m(7927)],y=function(E,g,r){const p={};let h=[];p.init=function(c){c=c||{},h.length=0,E.get("chat/search").on("keyup",utils.debounce(o,250));const d=$('[component="chat/search/list"]');d.on("click","[data-uid]",function(){c.onSelect&&c.onSelect(h.find(u=>parseInt(u.uid,10)===parseInt($(this).attr("data-uid"),10))),a(d)})};function a(c){E.get("chat/search").val(""),s(c),c.find('[component="chat/search/no-users"]').addClass("hidden"),c.find('[component="chat/search/start-typing"]').removeClass("hidden")}function o(){const c=$('[component="chat/search/list"]'),d=E.get("chat/search").val();if(!d)return a(c);c.find('[component="chat/search/start-typing"]').addClass("hidden"),g.get("/api/users",{query:d,searchBy:"username",paginate:!1}).then(l).catch(r.error)}function s(c){h.length=0,c.find("[data-uid]").remove()}async function l(c){const d=$('[component="chat/search/list"]');if(s(d),c.users=c.users.filter(function(v){return parseInt(v.uid,10)!==parseInt(app.user.uid,10)}),h=c.users,!c.users.length)return d.find('[component="chat/search/no-users"]').removeClass("hidden");d.find('[component="chat/search/no-users"]').addClass("hidden");const u=await app.parseAndTranslate("modals/create-room","searchUsers",{searchUsers:c.users});d.append(u),d.parent().toggleClass("show",!0)}return p}.apply(k,C),y!==void 0&&(w.exports=y)},86193:(w,k,m)=>{"use strict";var C,y;C=[m(74344),m(7927)],y=function(E,g){const r={},p={delay:200,appendTo:null};r.init=a=>{const o={...p,...a},{input:s,onSelect:l}=o;app.loadJQueryUI(function(){s.autocomplete({...o,open:function(){$(this).autocomplete("widget").css("z-index",100005)},select:function(c,d){h(s,l,c,d)}})})},r.user=function(a,o,s){typeof o=="function"&&(s=o,o={}),o=o||{},r.init({input:a,onSelect:s,source:(l,c)=>{o.query=l.term,E.get("/api/users",o,function(d,u){if(d)return g.error(d);if(u&&u.users){const v=u.users.map(function(x){const A=$("<div></div>").html(x.username).text();return x&&{label:A,value:A,user:{uid:x.uid,name:x.username,slug:x.userslug,username:x.username,userslug:x.userslug,picture:x.picture,banned:x.banned,"icon:text":x["icon:text"],"icon:bgColor":x["icon:bgColor"]}}});c(v)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},r.group=function(a,o){r.init({input:a,onSelect:o,source:(s,l)=>{socket.emit("groups.search",{query:s.term},function(c,d){if(c)return g.error(c);if(d&&d.length){const u=d.map(function(v){return v&&{label:v.name,value:v.name,group:v}});l(u)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},r.tag=function(a,o){r.init({input:a,onSelect:o,delay:100,source:(s,l)=>{socket.emit("topics.autocompleteTags",{query:s.term,cid:ajaxify.data.cid||0},function(c,d){if(c)return g.error(c);d&&l(d),$(".ui-autocomplete a").attr("data-ajaxify","false")})}})};function h(a,o,s,l){o=o||function(){};const c=jQuery.Event("keypress");c.which=13,c.keyCode=13,setTimeout(function(){a.trigger(c)},100),o(s,l)}return r}.apply(k,C),y!==void 0&&(w.exports=y)},2585:(w,k,m)=>{w.exports=m(61006)},83713:(w,k,m)=>{w.exports=m(51077)},33371:(w,k,m)=>{"use strict";var C,y;C=[m(7927)],y=function(E){const g={};return g.init=function(r){const p=r.uploadFormEl;if(p.length&&(p.attr("action",config.relative_path+r.route),r.dragDropAreaEl&&g.handleDragDrop({container:r.dragDropAreaEl,callback:function(h){g.ajaxSubmit({uploadForm:p,upload:h,callback:r.callback})}}),r.pasteEl&&g.handlePaste({container:r.pasteEl,callback:function(h){g.ajaxSubmit({uploadForm:p,upload:h,callback:r.callback})}}),r.uploadBtnEl)){const h=p.find('input[name="files[]"]');r.uploadBtnEl.on("click",function(){h.trigger("click")}),h.on("change",function(a){const o=(a.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);o&&g.ajaxSubmit({uploadForm:p,upload:{files:o,fileNames:Array.from(o).map(s=>s.name)},callback:r.callback})})}},g.handleDragDrop=function(r){let p=!1;const h=r.container,a=r.container.find(".imagedrop");h.on("dragenter",function(){p||(a.css("top","0px"),a.css("height",h.height()+"px"),a.css("line-height",h.height()+"px"),a.show(),a.on("dragleave",function(){a.hide(),a.off("dragleave")}))}),a.on("drop",function(l){l.preventDefault();const c=l.originalEvent.dataTransfer.files;if(c.length){let u;if(window.FormData){u=new FormData;for(var d=0;d<c.length;++d)u.append("files[]",c[d],c[d].name)}r.callback({files:c,formData:u})}return a.hide(),!1});function o(s){return s.preventDefault(),!1}$(document).off("dragstart").on("dragstart",function(){p=!0}).off("dragend").on("dragend, mouseup",function(){p=!1}),a.on("dragover",o),a.on("dragenter",o)},g.handlePaste=function(r){r.container.on("paste",function(h){const a=(h.clipboardData||h.originalEvent.clipboardData||{}).items,o=[],s=[];let l=null;window.FormData&&(l=new FormData),[].forEach.call(a,function(c){const d=c.getAsFile();if(d){const u=utils.generateUUID()+"-"+d.name;l&&l.append("files[]",d,u),o.push(d),s.push(u)}}),o.length&&r.callback({files:o,fileNames:s,formData:l})})},g.ajaxSubmit=function(r){const p=[...r.upload.files];for(let a=0;a<p.length;++a){const o=p[a].type.match(/image./);if(o&&!app.user.privileges["upload:post:image"]||!o&&!app.user.privileges["upload:post:file"])return E.error("[[error:no-privileges]]");if(!app.user.isAdmin&&p[a].size>parseInt(config.maximumFileSize,10)*1024)return r.uploadForm[0].reset(),E.error("[[error:file-too-big, "+config.maximumFileSize+"]]")}const h=Date.now();r.uploadForm.off("submit").on("submit",function(){return $(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:r.upload.formData,error:function(a){let o=a.responseJSON&&(a.responseJSON.error||a.responseJSON.status&&a.responseJSON.status.message)||"[[error:parse-error]]";a&&a.status===413&&(o=a.statusText||"Request Entity Too Large"),E.error(o),E.remove(h)},uploadProgress:function(a,o,s,l){E.alert({alert_id:h,message:"[[modules:composer.uploading, "+l+"%]]"})},success:function(a){const o=a.response.images;if(o&&o.length)for(var s=0;s<o.length;++s)o[s].filename=p[s].name,o[s].isImage=/image./.test(p[s].type);r.callback(o)},complete:function(){r.uploadForm[0].reset(),setTimeout(E.remove,100,h)}}),!1}),r.uploadForm.submit()},g}.apply(k,C),y!==void 0&&(w.exports=y)},51077:(w,k,m)=>{"use strict";var C,y;C=[m(85233)],y=function(E){var g={};return g.render=function(r,p){if(p=p||function(){},!r.find(".preview-container").is(":visible"))return p();var h=r.find("textarea");socket.emit("plugins.composer.renderPreview",h.val(),function(a,o){a||(o=$("<div>"+o+"</div>"),o.find("img:not(.not-responsive)").addClass("img-fluid"),r.find(".preview").html(o),E.fire("action:composer.preview",{postContainer:r,preview:o}),p())})},g.matchScroll=function(r){if(r.find(".preview-container").is(":visible")){var p=r.find("textarea"),h=r.find(".preview");if(p.length&&h.length){var a=p[0].scrollHeight-p.height();if(a===0)return;var o=p.scrollTop()/a;h.scrollTop(Math.max(h[0].scrollHeight-h.height(),0)*o)}}},g.handleToggler=function(r){const p=r.get(0);g.env=utils.findBootstrapEnvironment();const h=["xs","sm"].includes(g.env),a=p.querySelector('.formatting-bar [data-action="preview"]'),o=a.querySelector(".show-text"),s=a.querySelector(".hide-text"),l=localStorage.getItem("composer:previewToggled"),c=config["composer-default"].hidePreviewOnOpen==="on";let d=!h&&(l===null&&!c||l==="true");const u=p.querySelector(".preview-container"),v=p.querySelector(".write-container");if(!a)return;function x(A){h?(u.classList.toggle("hide",!1),v.classList.toggle("maximized",!1),u.classList.toggle("d-none",!A),u.classList.toggle("d-flex",A),u.classList.toggle("w-100",A),v.classList.toggle("d-flex",!A),v.classList.toggle("d-none",A),v.classList.toggle("w-100",!A)):(u.classList.toggle("hide",!A),v.classList.toggle("w-50",A),v.classList.toggle("w-100",!A),localStorage.setItem("composer:previewToggled",A)),o.classList.toggle("hide",A),s.classList.toggle("hide",!A),A&&g.render(r),g.matchScroll(r)}g.toggle=x,a.addEventListener("click",A=>{A.button===0&&(d=!d,x(d))}),x(d)},g}.apply(k,C),y!==void 0&&(w.exports=y)}}]);
